name: 🚀 JOHAN RDP PREMIUM PERSISTENT

on:
  workflow_dispatch:
    inputs:
      duration:
        description: '🕐 Waktu penggunaan'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      install_apps:
        description: '📦 Install Aplikasi (telegram,chrome,vscode,firefox,nodejs,python,discord,spotify)'
        required: false
        default: 'telegram,chrome,vscode'
        type: string
      custom_hostname:
        description: '🌐 Hostname Kustom'
        required: false
        default: 'johan-rdp-permanent'
        type: string

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER SELAMAT DATANG
      - name: 🎯 MULAI SISTEM PERSISTENT
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "🤖 JOHAN RDP PREMIUM PERSISTENT" -ForegroundColor Yellow
          Write-Host "⚡ Powered by JOHAN-RDP" -ForegroundColor Green
          Write-Host "🕒 Waktu: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host "👤 Username: JOHAN-RDP" -ForegroundColor Cyan
          Write-Host "🔐 Password: Shion@1234" -ForegroundColor Cyan
          Write-Host "🌐 Hostname: ${{ github.event.inputs.custom_hostname }}" -ForegroundColor Cyan
          Write-Host "📦 Apps: ${{ github.event.inputs.install_apps }}" -ForegroundColor Cyan
          Write-Host ""
          
          # Efek loading
          $frames = @('⣾', '⣽', '⣻', '⢿', '⡿', '⣟', '⣯', '⣷')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`r🚀 Memulai sistem persistent... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r✅ Sistem persistent siap!                    " -ForegroundColor Green

      # KONFIGURASI RDP
      - name: 🔧 KONFIGURASI RDP
        run: |
          Write-Host ""
          Write-Host "🛠️  MENGKONFIGURASI RDP" -ForegroundColor Yellow
          
          # Aktifkan RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Firewall
          netsh advfirewall firewall add rule name="JOHAN-RDP" dir=in action=allow protocol=TCP localport=3389 profile=any
          netsh advfirewall firewall add rule name="JOHAN-RDP-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
          
          # Service
          Set-Service -Name TermService -StartupType Automatic
          Start-Service -Name TermService
          
          Write-Host "✅ Konfigurasi RDP selesai!" -ForegroundColor Green

      # BUAT USER JOHAN-RDP
      - name: 👤 BUAT AKUN JOHAN-RDP
        run: |
          Write-Host ""
          Write-Host "👤 MEMBUAT AKUN JOHAN-RDP" -ForegroundColor Yellow
          
          $password = "Shion@1234"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Hapus user lama jika ada
          Remove-LocalUser -Name "JOHAN-RDP" -ErrorAction SilentlyContinue
          
          # Buat user baru
          New-LocalUser -Name "JOHAN-RDP" -Password $securePass -AccountNeverExpires -Description "Johan RDP Premium"
          Set-LocalUser -Name "JOHAN-RDP" -PasswordNeverExpires $true
          
          # Tambahkan ke grup
          Add-LocalGroupMember -Group "Administrators" -Member "JOHAN-RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "JOHAN-RDP"
          Enable-LocalUser -Name "JOHAN-RDP"
          
          Write-Host "✅ Akun JOHAN-RDP siap!" -ForegroundColor Green

      # INSTALL APLIKASI
      - name: 📦 INSTALL APLIKASI
        run: |
          Write-Host ""
          Write-Host "📦 MENGINSTAL APLIKASI" -ForegroundColor Yellow
          
          $appsToInstall = "${{ github.event.inputs.install_apps }}".ToLower().Split(',')
          Write-Host "Aplikasi yang akan diinstall: $($appsToInstall -join ', ')"
          
          # Download dan install aplikasi
          foreach ($app in $appsToInstall) {
              $app = $app.Trim()
              Write-Host "Menginstall $app..."
              
              switch ($app) {
                  "telegram" {
                      Invoke-WebRequest -Uri "https://telegram.org/dl/desktop/win64" -OutFile "$env:TEMP\telegram.exe"
                      Start-Process "$env:TEMP\telegram.exe" -ArgumentList "/S" -Wait
                      Remove-Item "$env:TEMP\telegram.exe" -Force
                  }
                  "chrome" {
                      Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "$env:TEMP\chrome.exe"
                      Start-Process "$env:TEMP\chrome.exe" -ArgumentList "/silent /install" -Wait
                      Remove-Item "$env:TEMP\chrome.exe" -Force
                  }
                  "vscode" {
                      Invoke-WebRequest -Uri "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64" -OutFile "$env:TEMP\vscode.exe"
                      Start-Process "$env:TEMP\vscode.exe" -ArgumentList "/SILENT /MERGETASKS=!runcode" -Wait
                      Remove-Item "$env:TEMP\vscode.exe" -Force
                  }
                  "firefox" {
                      Invoke-WebRequest -Uri "https://download.mozilla.org/?product=firefox-latest&os=win64&lang=en-US" -OutFile "$env:TEMP\firefox.exe"
                      Start-Process "$env:TEMP\firefox.exe" -ArgumentList "/S" -Wait
                      Remove-Item "$env:TEMP\firefox.exe" -Force
                  }
              }
              Write-Host "✅ $app terinstall"
          }

      # SETUP TAILSCALE DENGAN HOSTNAME KUSTOM
      - name: 🌐 SETUP JARINGAN
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "🌐 SETUP JARINGAN TAILSCALE" -ForegroundColor Yellow
          
          # Install Tailscale
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "`"$env:TEMP\tailscale.msi`"", "/quiet", "/norestart" -Wait
          Remove-Item "$env:TEMP\tailscale.msi" -Force
          
          Start-Sleep -Seconds 10
          
          # Koneksi dengan hostname kustom
          $hostname = "${{ github.event.inputs.custom_hostname }}"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=$hostname --accept-routes --accept-dns --reset
          
          # Dapatkan IP
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
              if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                  echo "RDP_IP=$ip" >> $env:GITHUB_ENV
                  break
              }
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip) {
              $magicDNS = "$hostname.tailscale-up"
              echo "RDP_IP=$magicDNS" >> $env:GITHUB_ENV
          }
          
          Write-Host "✅ Jaringan siap! IP: $env:RDP_IP" -ForegroundColor Green

      # BUAT SHORTCUT DI DESKTOP
      - name: 🖥️ SETUP DESKTOP
        run: |
          Write-Host ""
          Write-Host "🖥️  SETUP SHORTCUT DESKTOP" -ForegroundColor Yellow
          
          $desktopPath = "C:\Users\JOHAN-RDP\Desktop"
          New-Item -ItemType Directory -Path $desktopPath -Force
          
          # Buat file info koneksi
          $info = @"
🎯 JOHAN RDP PREMIUM
====================
IP: $env:RDP_IP
User: JOHAN-RDP
Pass: Shion@1234
Port: 3389
"@
          $info | Out-File "$desktopPath\INFO_RDP.txt" -Encoding UTF8
          
          Write-Host "✅ Setup desktop selesai!" -ForegroundColor Green

      # TAMPILKAN INFO KONEKSI
      - name: 🎉 INFO KONEKSI
        run: |
          Write-Host ""
          Write-Host "┌─────────────────────────────────────────┐" -ForegroundColor Cyan
          Write-Host "│           🎉 RDP SIAP DIGUNAKAN!       │" -ForegroundColor Cyan
          Write-Host "├─────────────────────────────────────────┤" -ForegroundColor Cyan
          Write-Host "│ 🌐 IP: $env:RDP_IP" -ForegroundColor White
          Write-Host "│ 👤 User: JOHAN-RDP" -ForegroundColor White
          Write-Host "│ 🔐 Pass: Shion@1234" -ForegroundColor White
          Write-Host "│ 📍 Port: 3389" -ForegroundColor White
          Write-Host "│ ⏰ Waktu: ${{ github.event.inputs.duration }}" -ForegroundColor White
          Write-Host "│ 📦 Apps: ${{ github.event.inputs.install_apps }}" -ForegroundColor White
          Write-Host "├─────────────────────────────────────────┤" -ForegroundColor Cyan
          Write-Host "│ 💡 Catat informasi di atas!            │" -ForegroundColor Yellow
          Write-Host "│    Untuk reconnect, jalankan workflow  │" -ForegroundColor Yellow
          Write-Host "│    lagi dengan credential yang sama    │" -ForegroundColor Yellow
          Write-Host "└─────────────────────────────────────────┘" -ForegroundColor Cyan

      # JAGA SESI BERJALAN
      - name: ⏳ JAGA SESI AKTIF
        run: |
          $duration = "${{ github.event.inputs.duration }}"
          switch ($duration) {
              "1h" { $minutes = 60 }
              "3h" { $minutes = 180 }
              "5h40m" { $minutes = 340 }
          }
          
          Write-Host ""
          Write-Host "⏳ Menjaga sesi aktif selama $minutes menit..." -ForegroundColor Yellow
          
          $endTime = (Get-Date).AddMinutes($minutes)
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $hours = [math]::Floor($remaining.TotalHours)
              $mins = [math]::Floor($remaining.TotalMinutes % 60)
              $secs = [math]::Floor($remaining.TotalSeconds % 60)
              
              Write-Host "⏱️  Waktu tersisa: $hours jam $mins menit $secs detik" -ForegroundColor Blue
              Start-Sleep -Seconds 30
          }
          
          Write-Host "✅ Waktu habis! Sesi selesai." -ForegroundColor Green
