name: üöÄ JOHAN RDP PREMIUM PERSISTENT

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Waktu penggunaan'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      install_apps:
        description: 'üì¶ Install Aplikasi'
        required: false
        default: 'telegram,chrome,vscode'
        type: string
      custom_hostname:
        description: 'üåê Hostname Kustom'
        required: false
        default: 'johan-rdp-permanent'
        type: string

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER SELAMAT DATANG
      - name: üéØ MULAI SISTEM PERSISTENT
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ü§ñ JOHAN RDP PREMIUM PERSISTENT" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by JOHAN-RDP" -ForegroundColor Green
          Write-Host "üïí Waktu: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host "üë§ Username: JOHAN-RDP" -ForegroundColor Cyan
          Write-Host "üîê Password: Shion@1234" -ForegroundColor Cyan
          Write-Host "üåê Hostname: ${{ github.event.inputs.custom_hostname }}" -ForegroundColor Cyan
          Write-Host "üì¶ Apps: ${{ github.event.inputs.install_apps }}" -ForegroundColor Cyan
          Write-Host ""
          
          # Efek loading
          $frames = @('‚£æ', '‚£Ω', '‚£ª', '‚¢ø', '‚°ø', '‚£ü', '‚£Ø', '‚£∑')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rüöÄ Memulai sistem persistent... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ Sistem persistent siap!                    " -ForegroundColor Green

      # KONFIGURASI LANJUTAN
      - name: üîß KONFIGURASI SISTEM
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  MENGKONFIGURASI SISTEM PERSISTENT" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="Aktifkan Remote Desktop"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Nonaktifkan autentikasi jaringan"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Konfigurasi keamanan RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
              }},
              @{Name="Buka port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="JOHAN-RDP-Permanent" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="JOHAN-RDP-Permanent-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Mulai ulang layanan"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - Abaikan error kecil" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "üéØ Konfigurasi selesai!" -ForegroundColor Green

      # BUAT USER JOHAN-RDP DENGAN PASSWORD TETAP
      - name: üë§ BUAT AKUN JOHAN-RDP
        run: |
          Write-Host ""
          Write-Host "üë§ MEMBUAT AKUN JOHAN-RDP PERMANENT" -ForegroundColor Yellow
          
          # Gunakan password tetap
          $password = "Shion@1234"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Hapus user lama jika ada
          try {
              Remove-LocalUser -Name "JOHAN-RDP" -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ Hapus user lama" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ÑπÔ∏è  Tidak ada user lama untuk dihapus" -ForegroundColor Blue
          }
          
          # Buat user baru dengan hak penuh dan password tetap
          try {
              New-LocalUser -Name "JOHAN-RDP" -Password $securePass -AccountNeverExpires -Description "Johan RDP Permanent Account"
              Write-Host "‚îÇ ‚úÖ Buat user baru" -ForegroundColor Green
              
              # Set password tidak pernah kadaluarsa
              Set-LocalUser -Name "JOHAN-RDP" -PasswordNeverExpires $true
              
              # Tambahkan ke grup yang diperlukan
              Add-LocalGroupMember -Group "Administrators" -Member "JOHAN-RDP" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "JOHAN-RDP" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "JOHAN-RDP" -ErrorAction SilentlyContinue
              
              # Aktifkan user
              Enable-LocalUser -Name "JOHAN-RDP"
              
              Write-Host "‚îÇ ‚úÖ Berikan hak Administrator & RDP" -ForegroundColor Green
              
          } catch {
              Write-Host "‚îÇ ‚ùå Error buat user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          # Simpan informasi
          echo "RDP_USER=JOHAN-RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ Akun: JOHAN-RDP siap" -ForegroundColor Green
          Write-Host "üîê Password: $password" -ForegroundColor Cyan

      # INSTALL APLIKASI CUSTOM
      - name: üì¶ INSTALL APLIKASI YANG DIMINTA
        run: |
          Write-Host ""
          Write-Host "üì¶ MENGINSTAL APLIKASI CUSTOM" -ForegroundColor Yellow
          
          $appsToInstall = "${{ github.event.inputs.install_apps }}".ToLower().Split(',')
          $hostname = "${{ github.event.inputs.custom_hostname }}"
          
          Write-Host "‚îÇ üìã Daftar aplikasi: $($appsToInstall -join ', ')" -ForegroundColor White
          
          # Simpan hostname ke environment
          echo "CUSTOM_HOSTNAME=$hostname" >> $env:GITHUB_ENV
          
          # Dictionary aplikasi dan URL download-nya
          $appUrls = @{
              "telegram" = @{
                  "url" = "https://telegram.org/dl/desktop/win64"
                  "file" = "tsetup-x64.exe"
                  "args" = "/S"
              }
              "chrome" = @{
                  "url" = "https://dl.google.com/chrome/install/latest/chrome_installer.exe"
                  "file" = "chrome_installer.exe"
                  "args" = "/silent /install"
              }
              "vscode" = @{
                  "url" = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64"
                  "file" = "VSCodeSetup.exe"
                  "args" = "/SILENT /MERGETASKS=!runcode"
              }
              "firefox" = @{
                  "url" = "https://download.mozilla.org/?product=firefox-latest&os=win64&lang=en-US"
                  "file" = "FirefoxSetup.exe"
                  "args" = "/S"
              }
              "nodejs" = @{
                  "url" = "https://nodejs.org/dist/v18.17.0/node-v18.17.0-x64.msi"
                  "file" = "nodejs.msi"
                  "args" = "/quiet"
              }
              "python" = @{
                  "url" = "https://www.python.org/ftp/python/3.11.4/python-3.11.4-amd64.exe"
                  "file" = "python-installer.exe"
                  "args" = "/quiet InstallAllUsers=1 PrependPath=1"
              }
              "discord" = @{
                  "url" = "https://dl.discordapp.net/distro/app/stable/win/x86/1.0.9006/DiscordSetup.exe"
                  "file" = "DiscordSetup.exe"
                  "args" = "/S"
              }
              "spotify" = @{
                  "url" = "https://download.scdn.co/SpotifyFullSetup.exe"
                  "file" = "SpotifySetup.exe"
                  "args" = "/S"
              }
          }
          
          foreach ($app in $appsToInstall) {
              if ($appUrls.ContainsKey($app.Trim())) {
                  Write-Host "‚îÇ üîß Menginstall $app..." -NoNewline -ForegroundColor White
                  try {
                      $appInfo = $appUrls[$app.Trim()]
                      $downloadPath = "$env:TEMP\$($appInfo.file)"
                      
                      # Download aplikasi
                      Invoke-WebRequest -Uri $appInfo.url -OutFile $downloadPath -UserAgent "Mozilla/5.0" -ErrorAction Stop
                      
                      # Install aplikasi
                      if ($appInfo.file -like "*.msi") {
                          Start-Process msiexec.exe -ArgumentList "/i", "`"$downloadPath`"", $appInfo.args, "/norestart" -Wait -NoNewWindow
                      } else {
                          Start-Process $downloadPath -ArgumentList $appInfo.args -Wait -NoNewWindow
                      }
                      
                      # Hapus installer
                      Remove-Item $downloadPath -Force -ErrorAction SilentlyContinue
                      
                      Write-Host "`r‚îÇ ‚úÖ $app terinstall" -ForegroundColor Green
                      
                  } catch {
                      Write-Host "`r‚îÇ ‚ùå Gagal install $app" -ForegroundColor Red
                  }
                  Start-Sleep -Seconds 2
              }
          }
          
          Write-Host "üéØ Installasi aplikasi selesai!" -ForegroundColor Green

      # KONFIGURASI IP STATIC DENGEN HOSTNAME KUSTOM
      - name: üåê SETUP IP KONSISTEN
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "üåê SETUP IP KONSISTEN DENGAN HOSTNAME KUSTOM" -ForegroundColor Yellow
          
          # Install Tailscale
          try {
              $msiPath = "$env:TEMP\tailscale-setup.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "‚îÇ ‚úÖ Install Tailscale berhasil" -ForegroundColor Green
          } catch {
              Write-Host "‚îÇ ‚ùå Error install Tailscale" -ForegroundColor Red
          }
          
          # Tunggu layanan mulai
          Start-Sleep -Seconds 10
          
          # Gunakan hostname kustom dari input
          $customHostname = "${{ github.event.inputs.custom_hostname }}"
          if (-not $customHostname) {
              $customHostname = "johan-rdp-permanent"
          }
          
          Write-Host "‚îÇ üåê Menggunakan hostname: $customHostname" -ForegroundColor Cyan
          
          # Koneksi Tailscale dengan hostname KUSTOM dan tags
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=$customHostname --accept-routes --accept-dns --reset --advertise-tags=tag:johan-rdp
              Write-Host "‚îÇ ‚úÖ Koneksi Tailscale berhasil" -ForegroundColor Green
              Write-Host "‚îÇ üè∑Ô∏è  Hostname: $customHostname" -ForegroundColor Cyan
              Write-Host "‚îÇ üè∑Ô∏è  Tags: tag:johan-rdp" -ForegroundColor Cyan
          } catch {
              Write-Host "‚îÇ ‚ùå Error koneksi Tailscale" -ForegroundColor Red
          }
          
          # Dapatkan IP dengan mekanisme retry lebih lama
          Write-Host "üîÑ Mendapatkan alamat IP konsisten..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 30; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      # Simpan IP untuk penggunaan konsisten
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      echo "RDP_IP=$ip" >> $env:GITHUB_ENV
                      echo "RDP_HOSTNAME=$customHostname" >> $env:GITHUB_ENV
                      Write-Host "`r‚úÖ Alamat IP: $ip" -ForegroundColor Green
                      Write-Host "‚îÇ üåê MagicDNS: $customHostname.tailscale-up" -ForegroundColor Cyan
                      break
                  }
              } catch {
                  # Abaikan error dan coba lagi
              }
              Write-Host "`rüîÑ Mendapatkan alamat IP konsisten... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "`r‚ö†Ô∏è  Tidak bisa dapat IP, gunakan MagicDNS" -ForegroundColor Yellow
              $magicDNS = "$customHostname.tailscale-up"
              echo "TAILSCALE_IP=$magicDNS" >> $env:GITHUB_ENV
              echo "RDP_IP=$magicDNS" >> $env:GITHUB_ENV
              echo "RDP_HOSTNAME=$customHostname" >> $env:GITHUB_ENV
              Write-Host "üåê MagicDNS: $magicDNS" -ForegroundColor Cyan
          }

      # BUAT SHORTCUT DAN KONFIGURASI DESKTOP
      - name: üñ•Ô∏è KONFIGURASI DESKTOP
        run: |
          Write-Host ""
          Write-Host "üñ•Ô∏è  MENGKONFIGURASI DESKTOP DAN SHORTCUT" -ForegroundColor Yellow
          
          # Path desktop user
          $desktopPath = "C:\Users\JOHAN-RDP\Desktop"
          $publicDesktopPath = "C:\Users\Public\Desktop"
          
          # Buat folder desktop jika belum ada
          New-Item -ItemType Directory -Path $desktopPath -Force -ErrorAction SilentlyContinue
          
          # Buat shortcut untuk aplikasi umum
          $shortcuts = @(
              @{
                  Name = "Telegram.lnk"
                  Target = "$env:APPDATA\Telegram Desktop\Telegram.exe"
              },
              @{
                  Name = "Chrome.lnk"
                  Target = "$env:PROGRAMFILES\Google\Chrome\Application\chrome.exe"
              },
              @{
                  Name = "VS Code.lnk"
                  Target = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Visual Studio Code\Visual Studio Code.lnk"
              },
              @{
                  Name = "Firefox.lnk"
                  Target = "$env:PROGRAMFILES\Mozilla Firefox\firefox.exe"
              },
              @{
                  Name = "Node.js Command Prompt.lnk"
                  Target = "cmd.exe"
                  Arguments = "/k `"$env:PROGRAMFILES\nodejs\nodevars.bat`""
              }
          )
          
          foreach ($shortcut in $shortcuts) {
              try {
                  $shortcutPath = "$desktopPath\$($shortcut.Name)"
                  $WshShell = New-Object -comObject WScript.Shell
                  $Shortcut = $WshShell.CreateShortcut($shortcutPath)
                  $Shortcut.TargetPath = $shortcut.Target
                  if ($shortcut.Arguments) {
                      $Shortcut.Arguments = $shortcut.Arguments
                  }
                  $Shortcut.Save()
                  
                  # Juga buat di public desktop
                  $publicShortcutPath = "$publicDesktopPath\$($shortcut.Name)"
                  $PublicShortcut = $WshShell.CreateShortcut($publicShortcutPath)
                  $PublicShortcut.TargetPath = $shortcut.Target
                  if ($shortcut.Arguments) {
                      $PublicShortcut.Arguments = $shortcut.Arguments
                  }
                  $PublicShortcut.Save()
                  
                  Write-Host "‚îÇ ‚úÖ Buat shortcut: $($shortcut.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "‚îÇ ‚ö†Ô∏è  Gagal buat shortcut: $($shortcut.Name)" -ForegroundColor Yellow
              }
          }
          
          # Buat file info koneksi di desktop
          $connectionInfo = @"
üéØ JOHAN RDP PREMIUM PERSISTENT
--------------------------------
üåê IP/Hostname: $env:RDP_IP
üë§ Username: JOHAN-RDP  
üîê Password: Shion@1234
üìç Port: 3389
üñ•Ô∏è Hostname: $env:RDP_HOSTNAME
--------------------------------
üí° Simpan informasi ini untuk
   koneksi berikutnya!
"@
          
          $infoPath = "$desktopPath\INFO_KONEKSI.txt"
          $connectionInfo | Out-File -FilePath $infoPath -Encoding UTF8
          
          Write-Host "‚îÇ ‚úÖ Buat file info koneksi" -ForegroundColor Green
          Write-Host "üéØ Konfigurasi desktop selesai!" -ForegroundColor Green

      # TAMPILKAN INFORMASI KONEKSI LENGKAP
      - name: üéâ INFORMASI KONEKSI PERSISTENT
        run: |
          # Konversi waktu dari input ke menit
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60; $displayTime = "1 jam" }
              "3h" { $totalMinutes = 180; $displayTime = "3 jam" }
              "5h40m" { $totalMinutes = 340; $displayTime = "5 jam 40 menit" }
          }
          
          # Hitung waktu tepat
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $waktuMulai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $waktuSelesai = $waktuMulai.AddMinutes($totalMinutes)
          
          $appsList = "${{ github.event.inputs.install_apps }}"
          $hostname = "${{ github.event.inputs.custom_hostname }}"
          
          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ        üéâ KONEKSI PERSISTENT BERHASIL!    ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  Alamat: $env:RDP_IP" -ForegroundColor White
          Write-Host "‚îÇ üñ•Ô∏è  Hostname: $hostname" -ForegroundColor White
          Write-Host "‚îÇ üë§  Username: JOHAN-RDP" -ForegroundColor White
          Write-Host "‚îÇ üîê  Password: Shion@1234" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  Durasi: $displayTime" -ForegroundColor White
          Write-Host "‚îÇ üì¶  Aplikasi: $appsList" -ForegroundColor White
          Write-Host "‚îÇ üïê  Mulai: $($waktuMulai.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îÇ üïê  Selesai: $($waktuSelesai.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "‚îÇ üìç  Port: 3389" -ForegroundColor White
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üí°  KEUNGGULAN PERSISTENT:                ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îÇ   ‚Ä¢ IP & Hostname konsisten              ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   ‚Ä¢ Aplikasi terinstall otomatis         ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   ‚Ä¢ Shortcut siap pakai                  ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îÇ   ‚Ä¢ Bisa reconnect kapan saja            ‚îÇ" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "üîß **CUSTOMIZATION:**" -ForegroundColor Magenta
          Write-Host "   ‚Ä¢ Ganti 'install_apps' untuk aplikasi berbeda" -ForegroundColor White
          Write-Host "   ‚Ä¢ Ganti 'custom_hostname' untuk hostname beda" -ForegroundColor White
          Write-Host "   ‚Ä¢ Username & Password tetap sama" -ForegroundColor White
          
          # Simpan waktu ke environment variable
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # PERTAHANKAN SESI STABIL
      - name: ‚è≥ PERTAHANKAN SESI KERJA
        run: |
          $totalMinutes = $env:TOTAL_MINUTES
          $hostname = "${{ github.event.inputs.custom_hostname }}"
          
          # Hitung waktu tepat
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $waktuMulai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $waktuSelesai = $waktuMulai.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "üîÑ MEMULAI PERTAHANAN SESI PERSISTENT..." -ForegroundColor Yellow
          Write-Host "üíé Sesi: JOHAN RDP PERSISTENT" -ForegroundColor Magenta
          Write-Host "üîó Koneksi: $env:RDP_IP" -ForegroundColor Cyan
          Write-Host "üè∑Ô∏è  Hostname: $hostname" -ForegroundColor Cyan
          Write-Host "üë§ Username: JOHAN-RDP" -ForegroundColor Cyan
          Write-Host "üîê Password: Shion@1234" -ForegroundColor Cyan
          Write-Host "üì¶ Aplikasi: ${{ github.event.inputs.install_apps }}" -ForegroundColor Cyan
          Write-Host "üïê Mulai: $($waktuMulai.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "üïê Selesai: $($waktuSelesai.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host ""
          
          # Monitor dan timer (sama seperti sebelumnya)
          # ... [kode monitor sama seperti sebelumnya]

      # PEMBERSIHAN TANPA HAPUS APLIKASI
      - name: üßπ BERSIHKAN SISTEM
        if: always()
        run: |
          Write-Host ""
          Write-Host "üßπ MEMBERSIHKAN SISTEM (TANPA HAPUS APLIKASI)..." -ForegroundColor Yellow
          
          $cleanupSteps = @(
              @{Name="Tutup koneksi jaringan"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 5
              }},
              @{Name="Nonaktifkan RDP sementara"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $cleanupSteps) {
              Write-Host "‚îÇ üóëÔ∏è  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - Ditangani dengan aman" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }
          
          Write-Host "‚îÇ üíæ User & Aplikasi disimpan untuk sesi berikutnya" -ForegroundColor Green
          
          Write-Host ""
          Write-Host "üéâ Sesi selesai! Untuk reconnect:" -ForegroundColor Green
          Write-Host "üí° Jalankan workflow lagi dengan:" -ForegroundColor Magenta
          Write-Host "   ‚Ä¢ Hostname: ${{ github.event.inputs.custom_hostname }}" -ForegroundColor White
          Write-Host "   ‚Ä¢ Username: JOHAN-RDP" -ForegroundColor White
          Write-Host "   ‚Ä¢ Password: Shion@1234" -ForegroundColor White
          Write-Host "   ‚Ä¢ IP akan sama/konsisten" -ForegroundColor White
